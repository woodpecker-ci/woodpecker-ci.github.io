"use strict";(self.webpackChunkwoodpecker=self.webpackChunkwoodpecker||[]).push([["4559"],{90894:function(e,n,i){i.r(n),i.d(n,{default:()=>h,frontMatter:()=>o,metadata:()=>r,assets:()=>d,toc:()=>l,contentTitle:()=>t});var r=JSON.parse('{"id":"administration/configuration/backends/docker","title":"Docker","description":"This is the original backend used with Woodpecker. The docker backend executes each step inside a separate container started on the agent.","source":"@site/docs/30-administration/10-configuration/11-backends/10-docker.md","sourceDirName":"30-administration/10-configuration/11-backends","slug":"/administration/configuration/backends/docker","permalink":"/docs/next/administration/configuration/backends/docker","draft":false,"unlisted":false,"editUrl":"https://github.com/woodpecker-ci/woodpecker/edit/main/docs/docs/30-administration/10-configuration/11-backends/10-docker.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"toc_max_heading_level":2},"sidebar":"tutorialSidebar","previous":{"title":"Server","permalink":"/docs/next/administration/configuration/server"},"next":{"title":"Kubernetes","permalink":"/docs/next/administration/configuration/backends/kubernetes"}}'),s=i("74132"),c=i("24924");let o={toc_max_heading_level:2},t="Docker",d={},l=[{value:"Private registries",id:"private-registries",level:2},{value:"Step specific configuration",id:"step-specific-configuration",level:2},{value:"Run user",id:"run-user",level:3},{value:"Tips and tricks",id:"tips-and-tricks",level:2},{value:"Image cleanup",id:"image-cleanup",level:3},{value:"Podman",id:"podman",level:3},{value:"Environment variables",id:"environment-variables",level:2},{value:"BACKEND_DOCKER_NETWORK",id:"backend_docker_network",level:3},{value:"BACKEND_DOCKER_ENABLE_IPV6",id:"backend_docker_enable_ipv6",level:3},{value:"BACKEND_DOCKER_VOLUMES",id:"backend_docker_volumes",level:3},{value:"BACKEND_DOCKER_LIMIT_MEM_SWAP",id:"backend_docker_limit_mem_swap",level:3},{value:"BACKEND_DOCKER_LIMIT_MEM",id:"backend_docker_limit_mem",level:3},{value:"BACKEND_DOCKER_LIMIT_SHM_SIZE",id:"backend_docker_limit_shm_size",level:3},{value:"BACKEND_DOCKER_LIMIT_CPU_QUOTA",id:"backend_docker_limit_cpu_quota",level:3},{value:"BACKEND_DOCKER_LIMIT_CPU_SHARES",id:"backend_docker_limit_cpu_shares",level:3},{value:"BACKEND_DOCKER_LIMIT_CPU_SET",id:"backend_docker_limit_cpu_set",level:3}];function a(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"docker",children:"Docker"})}),"\n",(0,s.jsx)(n.p,{children:"This is the original backend used with Woodpecker. The docker backend executes each step inside a separate container started on the agent."}),"\n",(0,s.jsx)(n.h2,{id:"private-registries",children:"Private registries"}),"\n",(0,s.jsxs)(n.p,{children:["Woodpecker supports ",(0,s.jsx)(n.a,{href:"https://github.com/docker/docker-credential-helpers",children:"Docker credentials"})," to securely store registry credentials. Install your corresponding credential helper and configure it in your Docker config file passed via ",(0,s.jsx)(n.a,{href:"/docs/next/administration/configuration/server#docker_config",children:(0,s.jsx)(n.code,{children:"WOODPECKER_DOCKER_CONFIG"})}),"."]}),"\n",(0,s.jsx)(n.p,{children:"To add your credential helper to the Woodpecker server container you could use the following code to build a custom image:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dockerfile",children:"FROM woodpeckerci/woodpecker-server:latest-alpine\n\nRUN apk add -U --no-cache docker-credential-ecr-login\n"})}),"\n",(0,s.jsx)(n.h2,{id:"step-specific-configuration",children:"Step specific configuration"}),"\n",(0,s.jsx)(n.h3,{id:"run-user",children:"Run user"}),"\n",(0,s.jsxs)(n.p,{children:["By default the docker backend starts the step container without the ",(0,s.jsx)(n.code,{children:"--user"})," flag. This means the step container will use the default user of the container. To change this behavior you can set the ",(0,s.jsx)(n.code,{children:"user"})," backend option to the preferred user/group:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"steps:\n  - name: example\n    image: alpine\n    commands:\n      - whoami\n    backend_options:\n      docker:\n        user: 65534:65534\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The syntax is the same as the ",(0,s.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/run/#user",children:"docker run"})," ",(0,s.jsx)(n.code,{children:"--user"})," flag."]}),"\n",(0,s.jsx)(n.h2,{id:"tips-and-tricks",children:"Tips and tricks"}),"\n",(0,s.jsx)(n.h3,{id:"image-cleanup",children:"Image cleanup"}),"\n",(0,s.jsxs)(n.p,{children:["The agent ",(0,s.jsx)(n.strong,{children:"will not"})," automatically remove images from the host. This task should be managed by the host system. For example, you can use a cron job to periodically do clean-up tasks for the CI runner."]}),"\n",(0,s.jsx)(n.admonition,{type:"danger",children:(0,s.jsxs)(n.p,{children:["The following commands ",(0,s.jsx)(n.strong,{children:"are destructive"})," and ",(0,s.jsx)(n.strong,{children:"irreversible"})," it is highly recommended that you test these commands on your system before running them in production via a cron job or other automation."]})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Remove all unused images"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'docker image rm $(docker images --filter "dangling=true" -q --no-trunc)\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Remove Woodpecker volumes"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker volume rm $(docker volume ls --filter name=^wp_* --filter dangling=true  -q)\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"podman",children:"Podman"}),"\n",(0,s.jsxs)(n.p,{children:["There is no official support for Podman, but one can try to set the environment variable ",(0,s.jsx)(n.code,{children:"DOCKER_HOST"})," to point to the Podman socket. It might work. See also the ",(0,s.jsx)(n.a,{href:"https://woodpecker-ci.org/blog",children:"Blog posts"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"environment-variables",children:"Environment variables"}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_network",children:"BACKEND_DOCKER_NETWORK"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_NETWORK"})]}),"\n",(0,s.jsx)(n.li,{children:"Default: none"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Set to the name of an existing network which will be attached to all your pipeline containers (steps). Please be careful as this allows the containers of different pipelines to access each other!"}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_enable_ipv6",children:"BACKEND_DOCKER_ENABLE_IPV6"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_ENABLE_IPV6"})]}),"\n",(0,s.jsxs)(n.li,{children:["Default: ",(0,s.jsx)(n.code,{children:"false"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Enable IPv6 for the networks used by pipeline containers (steps). Make sure you configured your docker daemon to support IPv6."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_volumes",children:"BACKEND_DOCKER_VOLUMES"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_VOLUMES"})]}),"\n",(0,s.jsx)(n.li,{children:"Default: none"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["List of default volumes separated by comma to be mounted to all pipeline containers (steps). For example to use custom CA\ncertificates installed on host and host timezone use ",(0,s.jsx)(n.code,{children:"/etc/ssl/certs:/etc/ssl/certs:ro,/etc/timezone:/etc/timezone"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_limit_mem_swap",children:"BACKEND_DOCKER_LIMIT_MEM_SWAP"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_LIMIT_MEM_SWAP"})]}),"\n",(0,s.jsxs)(n.li,{children:["Default: ",(0,s.jsx)(n.code,{children:"0"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The maximum amount of memory a single pipeline container is allowed to swap to disk, configured in bytes. There is no limit if ",(0,s.jsx)(n.code,{children:"0"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_limit_mem",children:"BACKEND_DOCKER_LIMIT_MEM"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_LIMIT_MEM"})]}),"\n",(0,s.jsxs)(n.li,{children:["Default: ",(0,s.jsx)(n.code,{children:"0"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The maximum amount of memory a single pipeline container can use, configured in bytes. There is no limit if ",(0,s.jsx)(n.code,{children:"0"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_limit_shm_size",children:"BACKEND_DOCKER_LIMIT_SHM_SIZE"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_LIMIT_SHM_SIZE"})]}),"\n",(0,s.jsxs)(n.li,{children:["Default: ",(0,s.jsx)(n.code,{children:"0"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The maximum amount of memory of ",(0,s.jsx)(n.code,{children:"/dev/shm"})," allowed in bytes. There is no limit if ",(0,s.jsx)(n.code,{children:"0"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_limit_cpu_quota",children:"BACKEND_DOCKER_LIMIT_CPU_QUOTA"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_LIMIT_CPU_QUOTA"})]}),"\n",(0,s.jsxs)(n.li,{children:["Default: ",(0,s.jsx)(n.code,{children:"0"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The number of microseconds per CPU period that the container is limited to before throttled. There is no limit if ",(0,s.jsx)(n.code,{children:"0"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_limit_cpu_shares",children:"BACKEND_DOCKER_LIMIT_CPU_SHARES"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_LIMIT_CPU_SHARES"})]}),"\n",(0,s.jsxs)(n.li,{children:["Default: ",(0,s.jsx)(n.code,{children:"0"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The relative weight vs. other containers."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"backend_docker_limit_cpu_set",children:"BACKEND_DOCKER_LIMIT_CPU_SET"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Name: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_LIMIT_CPU_SET"})]}),"\n",(0,s.jsx)(n.li,{children:"Default: none"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Comma-separated list to limit the specific CPUs or cores a pipeline container can use."}),"\n",(0,s.jsxs)(n.p,{children:["Example: ",(0,s.jsx)(n.code,{children:"WOODPECKER_BACKEND_DOCKER_LIMIT_CPU_SET=1,2"})]})]})}function h(e={}){let{wrapper:n}={...(0,c.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},24924:function(e,n,i){i.d(n,{Z:function(){return t},a:function(){return o}});var r=i(39546);let s={},c=r.createContext(s);function o(e){let n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(c.Provider,{value:n},e.children)}}}]);