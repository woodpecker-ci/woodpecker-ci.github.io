"use strict";(self.webpackChunkwoodpecker=self.webpackChunkwoodpecker||[]).push([["9398"],{34928(e,n,o){o.r(n),o.d(n,{metadata:()=>r,default:()=>h,frontMatter:()=>i,contentTitle:()=>c,toc:()=>d,assets:()=>a});var r=JSON.parse('{"id":"administration/installation/docker-compose","title":"Docker Compose","description":"This example docker-compose setup shows the deployment of a Woodpecker instance connected to GitHub (WOODPECKER_GITHUB=true). If you are using another forge, please change this including the respective secret settings.","source":"@site/versioned_docs/version-3.12/30-administration/05-installation/10-docker-compose.md","sourceDirName":"30-administration/05-installation","slug":"/administration/installation/docker-compose","permalink":"/docs/3.12/administration/installation/docker-compose","draft":false,"unlisted":false,"editUrl":"https://github.com/woodpecker-ci/woodpecker/edit/main/docs/versioned_docs/version-3.12/30-administration/05-installation/10-docker-compose.md","tags":[],"version":"3.12","sidebarPosition":10,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"General","permalink":"/docs/3.12/administration/general"},"next":{"title":"Helm Chart","permalink":"/docs/3.12/administration/installation/helm-chart"}}'),s=o(35656),t=o(86145);let i={},c="Docker Compose",a={},d=[{value:"Handling sensitive data",id:"handling-sensitive-data",level:2}];function l(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"docker-compose",children:"Docker Compose"})}),"\n",(0,s.jsxs)(n.p,{children:["This example ",(0,s.jsx)(n.a,{href:"https://docs.docker.com/compose/",children:"docker-compose"})," setup shows the deployment of a Woodpecker instance connected to GitHub (",(0,s.jsx)(n.code,{children:"WOODPECKER_GITHUB=true"}),"). If you are using another forge, please change this including the respective secret settings."]}),"\n",(0,s.jsxs)(n.p,{children:["It creates persistent volumes for the server and agent config directories. The bundled SQLite DB is stored in ",(0,s.jsx)(n.code,{children:"/var/lib/woodpecker"})," and is the most important part to be persisted as it holds all users and repository information."]}),"\n",(0,s.jsxs)(n.p,{children:["The server uses the default port ",(0,s.jsx)(n.code,{children:"8000"})," and gets exposed to the host here, so WoodpeckerWO can be accessed through this port on the host or by a reverse proxy sitting in front of it."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="docker-compose.yaml"',children:"services:\n  woodpecker-server:\n    image: woodpeckerci/woodpecker-server:v3\n    ports:\n      - 8000:8000\n    volumes:\n      - woodpecker-server-data:/var/lib/woodpecker/\n    environment:\n      - WOODPECKER_OPEN=true\n      - WOODPECKER_HOST=${WOODPECKER_HOST}\n      - WOODPECKER_GITHUB=true\n      - WOODPECKER_GITHUB_CLIENT=${WOODPECKER_GITHUB_CLIENT}\n      - WOODPECKER_GITHUB_SECRET=${WOODPECKER_GITHUB_SECRET}\n      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}\n\n  woodpecker-agent:\n    image: woodpeckerci/woodpecker-agent:v3\n    command: agent\n    restart: always\n    depends_on:\n      - woodpecker-server\n    volumes:\n      - woodpecker-agent-config:/etc/woodpecker\n      - /var/run/docker.sock:/var/run/docker.sock\n    environment:\n      - WOODPECKER_SERVER=woodpecker-server:9000\n      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}\n\nvolumes:\n  woodpecker-server-data:\n  woodpecker-agent-config:\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Woodpecker must know its own address. You must therefore specify the public address in the format ",(0,s.jsx)(n.code,{children:"<scheme>://<hostname>"}),". Please omit any trailing slashes:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",metastring:'title="docker-compose.yaml"',children:" services:\n   woodpecker-server:\n     [...]\n     environment:\n       - [...]\n+      - WOODPECKER_HOST=${WOODPECKER_HOST}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["It is also possible to customize the ports used. Woodpecker uses a separate port for gRPC and for HTTP. The agent makes gRPC calls and connects to the gRPC port. They can be configured with ",(0,s.jsx)(n.code,{children:"*_ADDR"})," variables:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",metastring:'title="docker-compose.yaml"',children:" services:\n   woodpecker-server:\n     [...]\n     environment:\n       - [...]\n+      - WOODPECKER_GRPC_ADDR=${WOODPECKER_GRPC_ADDR}\n+      - WOODPECKER_SERVER_ADDR=${WOODPECKER_HTTP_ADDR}\n"})}),"\n",(0,s.jsx)(n.p,{children:"If the agents establish a connection via the Internet, TLS encryption should be activated for gRPC. The agent must then be configured properly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",metastring:'title="docker-compose.yaml"',children:" services:\n   woodpecker-agent:\n     [...]\n     environment:\n       - [...]\n+      - WOODPECKER_GRPC_SECURE=true # defaults to false\n+      - WOODPECKER_GRPC_VERIFY=true # default\n"})}),"\n",(0,s.jsx)(n.p,{children:"As agents execute pipeline steps as Docker containers, they require access to the Docker daemon of the host machine:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",metastring:'title="docker-compose.yaml"',children:" services:\n   [...]\n   woodpecker-agent:\n     [...]\n+    volumes:\n+      - /var/run/docker.sock:/var/run/docker.sock\n"})}),"\n",(0,s.jsx)(n.p,{children:"Agents require the server address for communication between agents and servers. The agent connects to the gRPC port of the server:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",metastring:'title="docker-compose.yaml"',children:" services:\n   woodpecker-agent:\n     [...]\n     environment:\n+      - WOODPECKER_SERVER=woodpecker-server:9000\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The server and the agents use a shared secret to authenticate the communication. This should be a random string, which you should keep secret. You can create such a string with ",(0,s.jsx)(n.code,{children:"openssl rand -hex 32"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",metastring:'title="docker-compose.yaml"',children:" services:\n   woodpecker-server:\n     [...]\n     environment:\n       - [...]\n+      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}\n   woodpecker-agent:\n     [...]\n     environment:\n       - [...]\n+      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"handling-sensitive-data",children:"Handling sensitive data"}),"\n",(0,s.jsxs)(n.p,{children:["There are several options for handling sensitive data in ",(0,s.jsx)(n.code,{children:"docker compose"})," or ",(0,s.jsx)(n.code,{children:"docker swarm"})," configurations:"]}),"\n",(0,s.jsxs)(n.p,{children:["For Docker Compose, you can use an ",(0,s.jsx)(n.code,{children:".env"})," file next to your compose configuration to store the secrets outside the compose file. Although this separates the configuration from the secrets, it is still not very secure."]}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, you can also use ",(0,s.jsx)(n.code,{children:"docker-secrets"}),". As it can be difficult to use ",(0,s.jsx)(n.code,{children:"docker-secrets"})," for environment variables, Woodpecker allows reading sensitive data from files by providing a ",(0,s.jsx)(n.code,{children:"*_FILE"})," option for all sensitive configuration variables. Woodpecker will then attempt to read the value directly from this file. Note that the original environment variable will overwrite the value read from the file if it is specified at the same time."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",metastring:'title="docker-compose.yaml"',children:" services:\n   woodpecker-server:\n     [...]\n     environment:\n       - [...]\n+      - WOODPECKER_AGENT_SECRET_FILE=/run/secrets/woodpecker-agent-secret\n+    secrets:\n+      - woodpecker-agent-secret\n+\n+ secrets:\n+   woodpecker-agent-secret:\n+     external: true\n"})}),"\n",(0,s.jsx)(n.p,{children:"To store values in a docker secret you can use the following command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'echo "my_agent_secret_key" | docker secret create woodpecker-agent-secret -\n'})})]})}function h(e={}){let{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},86145(e,n,o){o.d(n,{R:()=>i,x:()=>c});var r=o(57140);let s={},t=r.createContext(s);function i(e){let n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);