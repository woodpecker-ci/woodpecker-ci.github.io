"use strict";(self.webpackChunkwoodpecker=self.webpackChunkwoodpecker||[]).push([["6192"],{80655(e,n,i){i.r(n),i.d(n,{metadata:()=>o,default:()=>u,frontMatter:()=>s,contentTitle:()=>a,toc:()=>c,assets:()=>l});var o=JSON.parse('{"id":"usage/extensions/configuration-extension","title":"Configuration extension","description":"The configuration extension can be used to modify or generate Woodpeckers pipeline configurations. You can configure an HTTP endpoint in the repository settings in the extensions tab.","source":"@site/versioned_docs/version-3.12/20-usage/72-extensions/40-configuration-extension.md","sourceDirName":"20-usage/72-extensions","slug":"/usage/extensions/configuration-extension","permalink":"/docs/3.12/usage/extensions/configuration-extension","draft":false,"unlisted":false,"editUrl":"https://github.com/woodpecker-ci/woodpecker/edit/main/docs/versioned_docs/version-3.12/20-usage/72-extensions/40-configuration-extension.md","tags":[],"version":"3.12","sidebarPosition":40,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Extensions","permalink":"/docs/3.12/usage/extensions/"},"next":{"title":"Linter","permalink":"/docs/3.12/usage/linter"}}'),t=i(62615),r=i(35756);let s={},a="Configuration extension",l={},c=[{value:"Security",id:"security",level:2},{value:"Global configuration",id:"global-configuration",level:2},{value:"How it works",id:"how-it-works",level:2},{value:"Request",id:"request",level:3},{value:"Response",id:"response",level:3}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"configuration-extension",children:"Configuration extension"})}),"\n",(0,t.jsx)(n.p,{children:"The configuration extension can be used to modify or generate Woodpeckers pipeline configurations. You can configure an HTTP endpoint in the repository settings in the extensions tab."}),"\n",(0,t.jsx)(n.p,{children:"Using such an extension can be useful if you want to:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Preprocess the original configuration file with something like Go templating"}),"\n",(0,t.jsx)(n.li,{children:"Convert custom attributes to Woodpecker attributes"}),"\n",(0,t.jsx)(n.li,{children:"Add defaults to the configuration like default steps"}),"\n",(0,t.jsx)(n.li,{children:"Convert configuration files from a totally different format like Gitlab CI config, Starlark, Jsonnet, ..."}),"\n",(0,t.jsx)(n.li,{children:"Centralize configuration for multiple repositories in one place"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"security",children:"Security"}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["As Woodpecker will pass private information like tokens and will execute the returned configuration, it is extremely important to secure the external extension. Therefore Woodpecker signs every request. Read more about it in the ",(0,t.jsx)(n.a,{href:"/docs/3.12/usage/extensions/#security",children:"security section"}),"."]})}),"\n",(0,t.jsx)(n.h2,{id:"global-configuration",children:"Global configuration"}),"\n",(0,t.jsx)(n.p,{children:"In addition to the ability to configure the extension per repository, you can also configure a global endpoint in the Woodpecker server configuration. This can be useful if you want to use the extension for all repositories. Be careful if\nyou share your Woodpecker server with others as they will also use your configuration extension."}),"\n",(0,t.jsx)(n.p,{children:"The global configuration will be called before the repository specific configuration extension if both are configured."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ini",metastring:'title="Server"',children:"WOODPECKER_CONFIG_SERVICE_ENDPOINT=https://example.com/ciconfig\n"})}),"\n",(0,t.jsx)(n.h2,{id:"how-it-works",children:"How it works"}),"\n",(0,t.jsx)(n.p,{children:"When a pipeline is triggered Woodpecker will fetch the pipeline configuration from the repository, then make a HTTP POST request to the configured extension with a JSON payload containing some data like the repository, pipeline information and the current config files retrieved from the repository. The extension can then send back modified or even new pipeline configurations following Woodpeckers official yaml format that should be used."}),"\n",(0,t.jsx)(n.h3,{id:"request",children:"Request"}),"\n",(0,t.jsx)(n.p,{children:"The extension receives an HTTP POST request with the following JSON payload:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"class Request {\n  repo: Repo;\n  pipeline: Pipeline;\n  netrc: Netrc;\n  configuration: {\n    name: string; // filename of the configuration file\n    data: string; // content of the configuration file\n  }[];\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Checkout the following models for more information:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/woodpecker-ci/woodpecker/blob/main/server/model/repo.go",children:"repo model"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/woodpecker-ci/woodpecker/blob/main/server/model/pipeline.go",children:"pipeline model"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/woodpecker-ci/woodpecker/blob/main/server/model/netrc.go",children:"netrc model"})}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"netrc"})," data is pretty powerful as it contains credentials to access the repository. You can use this to clone the repository or even use the forge (Github or Gitlab, ...) API to get more information about the repository."]})}),"\n",(0,t.jsx)(n.p,{children:"Example request:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "repo": {\n    "id": 100,\n    "uid": "",\n    "user_id": 0,\n    "namespace": "",\n    "name": "woodpecker-test-pipeline",\n    "slug": "",\n    "scm": "git",\n    "git_http_url": "",\n    "git_ssh_url": "",\n    "link": "",\n    "default_branch": "",\n    "private": true,\n    "visibility": "private",\n    "active": true,\n    "config": "",\n    "trusted": false,\n    "protected": false,\n    "ignore_forks": false,\n    "ignore_pulls": false,\n    "cancel_pulls": false,\n    "timeout": 60,\n    "counter": 0,\n    "synced": 0,\n    "created": 0,\n    "updated": 0,\n    "version": 0\n  },\n  "pipeline": {\n    "author": "myUser",\n    "author_avatar": "https://myforge.com/avatars/d6b3f7787a685fcdf2a44e2c685c7e03",\n    "author_email": "my@email.com",\n    "branch": "main",\n    "changed_files": ["some-filename.txt"],\n    "commit": "2fff90f8d288a4640e90f05049fe30e61a14fd50",\n    "created_at": 0,\n    "deploy_to": "",\n    "enqueued_at": 0,\n    "error": "",\n    "event": "push",\n    "finished_at": 0,\n    "id": 0,\n    "link_url": "https://myforge.com/myUser/woodpecker-testpipe/commit/2fff90f8d288a4640e90f05049fe30e61a14fd50",\n    "message": "test old config\\n",\n    "number": 0,\n    "parent": 0,\n    "ref": "refs/heads/main",\n    "refspec": "",\n    "clone_url": "",\n    "reviewed_at": 0,\n    "reviewed_by": "",\n    "sender": "myUser",\n    "signed": false,\n    "started_at": 0,\n    "status": "",\n    "timestamp": 1645962783,\n    "title": "",\n    "updated_at": 0,\n    "verified": false\n  },\n  "configs": [\n    {\n      "name": ".woodpecker.yaml",\n      "data": "steps:\\n  - name: backend\\n    image: alpine\\n    commands:\\n      - echo \\"Hello there from Repo (.woodpecker.yaml)\\"\\n"\n    }\n  ]\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"response",children:"Response"}),"\n",(0,t.jsxs)(n.p,{children:["The extension should respond with a JSON payload containing the new configuration files in Woodpecker's official YAML format.\nIf the extension wants to keep the existing configuration files, it can respond with HTTP status ",(0,t.jsx)(n.code,{children:"204 No Content"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"class Response {\n  configs: {\n    name: string; // filename of the configuration file\n    data: string; // content of the configuration file\n  }[];\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Example response:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "configs": [\n    {\n      "name": "central-override",\n      "data": "steps:\\n  - name: backend\\n    image: alpine\\n    commands:\\n      - echo \\"Hello there from ConfigAPI\\"\\n"\n    }\n  ]\n}\n'})})]})}function u(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},35756(e,n,i){i.d(n,{R:()=>s,x:()=>a});var o=i(59471);let t={},r=o.createContext(t);function s(e){let n=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);